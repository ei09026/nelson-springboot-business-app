= Business Automation -  Springboot Runtime App
:toc:


== The Aim 

* A re-usable Springboot Busines Application with _minimal_ dependencies to provide a Runtime for JBPM/Drools (RHPAM/RHDM) business projects

image::images/aim.jpg[800,800] 

== The Requirements

1. *MUST:* be possible to load/expose a KJAR (KieContainer) by simply giving a GIT repository
2. *MUST:* Absolute minimum dependencies must be https://maven.repository.redhat.com/ga[Red Hat public maven artifacts] and availability of http://maven.apache.org/download.cgi?Preferred=ftp://mirror.reverse.net/pub/apache/[maven binary] 
3. *MUST:* 
4. *MUST:*
5. *MUST:*
6. *MUST:*

* 1. - *MUST:* I want to not be hindered by environmental dependencies what are these? (DB, NEXUS, ALL NEXUS Dependencies require in the image, Security for roles)
* 2. - *MUST:* I want to not be hindered by environmental dependencies running it (docker, kubernetes, openshift should be the same)
* 3. - *MUST:* to Have: I would like to have the option to externalize DB (with minimum -maven/springboot profile-)
* 4. - *MUST:* to Have: I would like to have Monitoring via RHPAM Monitor/Business Central possible)
* 5. - *MUST:* to Have: I would like to ???

== How To Use (non-CICD)

IMPORTANT: Important: Before using note that by default this App provides the minimum configurations. See xref:anchor-2[How To Further Configure the App]

1. _Fork_ this repository for every new service (ie. this is just a baseline)
2. _Run_ *JenkinspipelineBatch.sh* script to create KJARs binaries, a repository of their dependencies (along with the KJARs installed in it), configurations for the Springboot Runtime App (service-name.xml kie-server-state, application-XXX.properties) based on what is to run)
* *[Parameter 1]* a list of KJARs to be loaded into Springboot App. The list must have the following format `containerAlias-1#RuntimeStrategy#GIT_REPO-1,containerAlias-2#RuntimeStrategy#GIT_REPO-2,containerAlias-N#RuntimeStrategy#GIT_REPO-N`
* *[Parameter 2]* Name of Business Service (will be used for config file, `kieserver.serverId`, `kieserver.Name`)

	./JenkinspipelineBatch.sh ./JenkinspipelineBatch.sh basic#PER_PROCESS_INSTANCE#https://github.com/skoussou/basic-kjar,retail#PER_CASE#https://github.com/skoussou/example-retail-credit-kjar onboarding-service

3. Run the Service as xref:anchor-1[How to run the Sprinboot Service] and then Use the API
* Get Containers List

	curl -u 'user:user' -X GET --header 'Accept: application/json' 'http://127.0.0.1:8090/rest/server/containers'
	curl -u 'user:user' -X GET --header 'Accept: application/json' 'http://business-application-service-dev-pam.apps.cluster-workshop-d20a.workshop-d20a.example.opentlc.com/rest/server/containers'

* Start Process

	curl -u 'user:user' -X POST --header 'Content-Type: application/json' --header 'Accept: application/json' -d '{}' 'http://127.0.0.1:8090/rest/server/containers/[YOUR-ALIAS]/processes/[YOUR-PROCESS-ID]/instances'
	eg. curl -u 'user:user' -X POST --header 'Content-Type: application/json' --header 'Accept: application/json' -d '{}' 'http://127.0.0.1:8090/rest/server/containers/retail/processes/my-process/instances'
	curl -u 'user:user' -X POST --header 'Content-Type: application/json' --header 'Accept: application/json' -d '{}' 'http://business-application-service-dev-pam.apps.cluster-workshop-d20a.workshop-d20a.example.opentlc.com/rest/server/containers/basic-kjar-2.0.0/processes/my-process/instances'


[[anchor-1]]
=== How to run the Sprinboot Service

==== Run the service locally via Maven

	mvn spring-boot:run -Dspring-boot.run.profiles=h2 -Dspring-boot.run.jvmArguments="-Dkie.maven.settings.custom=settings-local-only.xml  -Dorg.kie.server.startup.strategy=LocalContainersStartupStrategy"

==== Run the service locally as Docker

	TBD

==== Run the service in K8s/Openshift cluster

mvn clean deploy -DaltReleaseDeploymentRepository=maven-snapshots::default::http://nexus-cicd-pam.apps.cluster-workshop-d20a.workshop-d20a.example.opentlc.com/repository/maven-snapshots

	mvn clean package -DskipTests=true -P openshift -Dmaven.artifact.threads=50
	mvn fabric8:deploy -Dfabric8.namespace=dev-pam -DskipTests=true -P openshift -Dmaven.artifact.threads=50

	
WARNING: JAVA_OPTIONS are not copied into deploymentConfig so you have to find in the DeploymentConfig

	          env:
	            - name: GC_MAX_METASPACE_SIZE
	              value: '512'

and append

	          env:
	            - name: GC_MAX_METASPACE_SIZE
	              value: '512'
	          env:
	            - name: JAVA_OPTIONS
	              value: "-Dorg.drools.server.filter.classes=true -Dspring.profiles.active=openshifth2 -Dorg.kie.server.startup.strategy=LocalContainersStartupStrategy -Dorg.kie.server.mode=PRODUCTION -Dkie.maven.settings.custom=/opt/jboss/.m2/settings.xml -Dorg.guvnor.m2repo.dir=/opt/jboss/.m2/repository"


== How To Use (CICD)

git clone https://github.com/ippul/offliner-maven-plugin.git




* CICD requirements to satisfy
** a) To install the KJARs in NEXUS server (normal CICD Lifecycle each KJAR has its own pipeline for release)
** b) To configure the Springboot Service App with settings.xml pointing to the repos where KJARs can be found
** c) To configure the Springboot Service App with the correct kie-server-state file (maybe automate)
** d) To give the repos of the KJARs to build a maven repo for their dependencies
** Steps
*** - prepare local-m2-repo based on KJARs to load containers for
*** - pull built KJARs from NEXUS (that is important since there may be more than 1 version of the same KJAR and can't build all) and save into local-m2-repo
*** - build the springboot app
*** - load everything into image

=== Docs on Openshift DSL Pipeline creation

* Logging into cluster https://github.com/jenkinsci/openshift-client-plugin#configuring-an-openshift-cluster[via openshift.withCluster] 



openshift.withCluster( 'mytempcloudcluster' ) {
    // ... operations relative to this cluster ...
}


[[anchor-2]]
== How To Further Configure the App

1. Security (Adding Users/External Security)
2. Database
3. Timers
4. APIs







